---
layout: post
title: 《比特币与加密货币技术2》：比特币如何做到去中心化
categories: geek
mathjax: true
---

总的来说，是技术手段集合激励机制实现的。

### 2.1 中心化与去中心化

去中心化与中心化是竞争兼合作的关系。

电子邮件协议是去中心化的，但是邮件服务提供商却是中心化的。

比特币是去中心化的，但是比特币交易所，钱包软件可以是中心化的。

比特币如何做到去中心化关心五个问题：

1. 谁在维护交易账本？
2. 谁有权批准哪个交易是正当有效的？
3. 谁在制造新的比特币？
4. 谁在制定系统变化规则？
5. 比特币是如何取得交易价值的？

### 2.2 分布式共识

**分布式共识协议** 在一个有n个节点的系统中，每一个节点都有一个输入值，其中有一些节点具有故障，甚至是恶意的。一个分布式共识协议有以下两个属性：

* 输入值的中止须经所有诚实节点来确定。
* 这个输入值必须由诚实节点来生成。

在比特币网络中，需要达成的共识：哪些交易可以进行广播，交易发生的次序。

在任何时点，比特币网络上的节点都包含一系列区块的总账本（已达成共识），还有一些没写进区块的交易（没有达成共识）。

每隔十分钟，节点提议自己的未被认可的交易成为已经达成共识的区块链后的下一个区块。需要通过共识协议选择正当有效的区块。它面临两个问题，一是网络不完美，而是存在恶意节点。

在理论上，很多共识协议都得出了不可能的结论，而比特币则运行良好，因为它引入了奖励机制和随机性。

### 2.3 使用区块链达成没有身份的共识

比特币没有身份，给共识协议带来了难点，可能产生女巫攻击（乱造节点）。

我们假设可以在系统中随意选择一个节点，假设无法通过制造假的节点来增强她的力量。

**隐形共识** ：在一个回合中，一个随机节点会被选中，提议这个链的下一个区块，其他节点隐性接受或拒绝，如果接受，则接龙，否则忽略这个新的区块。

简化版比特币共识算法：

1. 新的交易被广播到所有节点上；
2. 每个节点都将新的交易放进一个区块；
3. 在每个回合，一个随机的节点可以广播它的区块；
4. 其他节点可以选择接受这个区块，前提是如果区块里的交易都是正当的。
5. 节点们可以把以上区块的哈希值放进自己的区块里，以此来表示它们对那个新区块的认可。

该算法如何应对攻击：

**窃取比特币** 需要伪造比特币所有者签名（需要私钥），无法办到；

**拒绝服务攻击** 可以等待下一个诚实节点打包；

**双重支付攻击** 一个交易得到的确认次数越多（链越长），它被纳入长期共识链的概率越大（另外的双重支付则成为孤块），其增长是指数级的，实践中，一般6个确认就够了。

### 2.4 奖励机制与工作量证明

对表现诚实的节点奖励，直接用创造比特币的方法奖励生产区块的节点（如果不诚实，生产的节点中的比特币则不会纳入长期共识链）。

建立分布式共识的过程的应用就是一种货币——比特币。

**区块奖励** 造币，最初为每个区块50个，每生成210000个区块则金额减半，大约4年一次，目前已经减产两次了，也就是说，现在生产一个区块的奖励是12.5个比特币。所以比特币的上限是21 000 000个。

**交易费** 任何交易的制造者都可以选择让交易输出值币输入值小，而第一个创建区块把交易放进区块链的人可以获得这个差额。随着区块奖励逐渐发完，交易费会变得越来越重要，这其中的博弈还值得研究。

这样的共识机制存在三个问题：

1. 如何随机选择一个节点？
2. 大家都争抢想获得奖励怎么办？
3. 攻击者创建大量的女巫节点颠覆共识？

这些问题都通过工作量证明来解决，其核心理念是把随机选取节点改为根据节点占有某种资源的比例来选取节点，在比特币中，这种资源是计算能力，计算能力的比例决定了节点被自动选中的概率，而计算能力是用解Hash谜题的能力来衡量的，这个Hash谜题是，$$H(nonce\parallel prev\_hash\parallel tx\parallel tx \parallel ...\parallel tx)<target$$，其中$$nonce$$为要求得的随机数，$$prev\_hash$$为前一区块的hash指针，$$tx$$为交易记录。

这个Hash谜题难于计算，只有通过暴力尝试的方法，2014年底产生一个区块需要计算$$10^{20}$$次，参与这个过程的节点被称为矿工。

每产生2160个区块 ，$$target$$会被重新设定，以维持10分钟产生一个区块的设定，节点重复尝试随机数是一个伯努利试验，可近似为泊松过程，因此对某个矿工而言，发现下一区块的平均时间=10分钟/占全部计算能力的比例。

### 2.5 总结

挖矿的成本包括硬件投资和电费，通常是法币支付，而奖励则是比特币（区块奖励加交易费），所以比特币与法币的汇率很重要。

区块链的安全性、挖矿生态系统的健康程度和货币的价值这三者之间相互依赖、相互作用的关系。（安全才有价值，有价值才有人挖矿，有人挖矿才安全，如此循环）。

51%攻击无法偷币，可以阻止特定交易的区块形成，但是不能组织交易的广播，无法更改系统规则，但是可能摧毁大家对比特币的信心。