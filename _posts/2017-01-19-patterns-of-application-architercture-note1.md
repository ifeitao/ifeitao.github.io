---
layout: post
title:  《企业应用架构模式》笔记1
categories: coding
---
## 前言

本书议题：

1. 企业级应用程序的分层；
2. 构建领域（业务）逻辑；
3. 构建基于Web的用户界面；
4. 将内存模块（尤其是对象）关联到关系数据库；
5. 在无状态环境下处理会话状态；
6. 分布原则。

如何使用本书：通读第一部分，选读第二部分。

如何受益：造轮子时参考，用轮子时加深理解。

## 0 引言

### 0.1 架构

定义：

1. 最高层次的分解；
2. 系统中不一改变的决定。

架构的主观性：难以改变的才是架构，什么难以改变一定程度取决于开发者。浓缩出来的是架构。

应用最广的设计方式：层次。

### 0.2 企业应用

一些共通的问题：

1. 持久化数据；
2. 大量数据；
3. 很多人同时访问数据；
4. 大量操作数据的用户界面屏幕；
5. 与散步在企业周围的其他企业应用集成；
6. 概念的不一致性；
7. 复杂的业务“无逻辑”

### 0.3 企业应用的种类

1. 并发度高，业务逻辑简单；
2. 并发度低，业务逻辑复杂；
3. 小型软件，要考虑扩展与集成。

### 0.4 关于性能的考虑

性能指标：

1. 响应时间
2. 响应性
3. 等待时间
4. 吞吐率：每秒事务数（tps）
5. 负载
6. 负载敏感度/衰减
7. 容量：最大有效负载或吞吐率。
8. 可伸缩性：垂直/水平可伸缩性

## 0.5 模式

### 0.5.1 模式的结构

名字，意图和概要，动机，运行机制，使用时机，进一步阅读，例子

### 0.5.2 模式的局限性

局限性：不全面，不完备。

## 第一部分 表述

## 第一章 分层

分层的优点：

1. 无需了解细节；
2. 可以替换某层的实现；
3. 降低层次间依赖；
4. 标准化；
5. 为多种上层提供服务，复用

层次的缺陷：

1. 级联修改；
2. 效率问题。

### 1.1 企业应用中层次的演化 

1. 批处理；
2. 客户/服务器
3. 三层架构：基于面向对象技术、Web技术。

### 1.2  三个基本层次

1. 表现层：提供服务，显示信息，用于Web界面、胖客户端
2. 领域层：逻辑，系统中真正的核心；
3. 数据源层：与数据库、消息系统、事务管理器即其他软件包通信

对称视图vs非对称分层视图。

三层架构如何分隔：子程序级别，类级别，包级别

依赖性原则：领域层和数据源层绝对不要依赖于表现层。

如何区分领域逻辑和其他逻辑？替换思维：用批处理替换UI，使用xml替换数据库。

### 1.3 为各层选择运行环境

数据源层：一般位于服务器；

表现层：客户机或服务器（Web服务）

领域层：客户机，服务器，或客户机加服务器（不推荐）

复杂性增压器：分布，显式多线程，范型差异，多平台开发，极限性能要求

## 第2章 组织领域逻辑

三种方法：

1. 业务脚本：面向过程思维，从用户输入、输入处理，数据获取，数据处理，反馈等一条龙服务；和数据库交互简单，也可以模块化，但难以消除重复代码。
2. 领域模型：面向对象思维，易扩展，能表达复杂逻辑，但是反直觉，和数据库交互困难。
3. 表模块：数据库表对应数据集，以它为基础构建类，集成相应操作，领域模型的类有多个实例，而表模块的类一般只有一个实例，通过不同的Id来处理。

### 2.1 抉择

初始难度：领域模型>表模块>业务脚本

可扩展性：领域模型>表模块>业务脚本

1. 这是一个早期决策，后期更改难度大；
2. 可以混用；
3. 优先考虑领域模型；
4. 如果开发环境支持，UI对数据集友好，可以考虑表模块。

### 2.2 服务层

1. 位于领域模型或表模块之上
2. 放置事务控制和安全性功能
3. 最小化情况：服务层只是一个外观（建议使用）
4. 极端情况：业余逻辑以事务脚本的形式置于服务层，领域模型或表模块很简单
5. 折中：控制器-实体风格

## 第3章 映射到关系数据库

### 3.1 架构模式

分离SQL访问，便于理解，便于测试，便于管理。

如何隔离？

1. 表入口模式：一个表一个类，集成基本操作
2. 行入口模式：用一个对象描述一个数据表中的行
3. 记录集：用内存对象模拟数据表。

在引入领域模型后：

1. 模型十分接近数据库表，使用活动记录
2. 使用入口转换，不推荐
3. 使用数据映射器，复杂但通用，完全隔离。

### 3.2 行为问题

1. 如何保证同步？使用工作单元；
2. 如何放置相同数据多次加载？标识映射
3. 如何避免低效加载？延迟加载

### 3.3 读取数据

基于表交互：直接读取

基于行交互：查询器，封装SQL语句，工作在数据库状态

建议：一次返回多行而不要查询多次，适当使用联结操作

### 3.4 结构映射模式

用于行数据入口和数据映射器。

#### 3.4.1 关系的映射 

一对一关系：外键=>引用（外键映射，延迟加载，标识映射）

一对多关系：外键=>引用集合(依赖映射)

多对多关系：关联表映射

#### 3.4.2 继承

单表继承（结构简单，数据冗余）

具体表继承

类表继承（结构复杂，数据精简）

其他：值对象直接存储，不构造表，大对象直接存储序列化文件

### 3.5 建立映射

1.  建立领域模型时不用过多考虑数据库；
2. 应当为每次迭代建立数据库；
3. 双向映射：多个数据源时，一个数据源一个映射层，或者两步映射，内存=>逻辑存储=>实际物理存储

### 3.6 使用元数据

1. 利用反射自动生成数据表
2. 建立资源库
3. 查询对象：对象域表达式=>SQL

### 3.7 数据库连接

1. 连接池
2. 关闭方法：显式关闭，垃圾回收机制，捆绑到事务（工作单元）

### 3.8 其他问题

1. 注意列的排序问题，使用列名索引而不要列序号索引
2. 使用预编译的静态SQL

## 第4章 Web表现层

1. 使用脚本处理请求，直接输入响应文档，反人类
2. 使用模板，嵌入服务器脚本

输入控制器：处理请求

应用控制器：调度领域模型与视图

### 4.1 视图模式

模板视图：网页中嵌入程序语言代码，难以维护，解决方法：使用一个辅助对象使程序逻辑独立出来。

转换视图：领域数据可XML化时使用。

一步vs两步

1. 一步转换
2. 两步转换：页面模块化，页面母版技术

### 4.2 控制器模式

1. 页面控制器：包含视图功能和输入控制器功能
2. 前端控制器：解释URL请求，创建分离的对象来处理

